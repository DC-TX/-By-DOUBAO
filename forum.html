<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>怪人协会论坛</title>
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial, "Helvetica Neue", Helvetica, sans-serif}
  body{background:#f9f9f9;color:#222;line-height:1.6}
  .container{width:1100px;max-width:100%;margin:0 auto;padding:20px}
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
  .logo{font-weight:700}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{padding:8px 12px;border-radius:6px;border:1px solid #000;background:#fff;cursor:pointer}
  .btn-primary{background:#000;color:#fff}
  .post-box{background:#fff;padding:14px;border-radius:8px;border:1px solid #e6e6e6}
  .board-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:18px}
  .post-item{background:#fff;border:1px solid #eee;padding:12px;border-radius:6px;display:flex;gap:12px;align-items:flex-start}
  .avatar{width:48px;height:48px;border-radius:50%;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .post-meta{font-size:12px;color:#666}
  .comment-list{margin-top:10px;border-top:1px dashed #eee;padding-top:10px}
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:999}
  .modal .modal-content{background:#fff;padding:16px;border-radius:8px;width:720px;max-width:94%}
  @media(max-width:768px){.container{padding:12px}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">怪人协会论坛</div>
      <div class="controls">
        <a href="index.html" class="btn">返回成员页</a>
        <div id="user-status" style="font-size:14px;color:#333"></div>
      </div>
    </div>

    <div class="post-box">
      <div style="font-weight:700;margin-bottom:8px">发新帖（登录后可发）</div>
      <input id="post-title" placeholder="标题" style="width:100%;padding:10px;border:1px solid #e6e6e6;border-radius:6px;margin-bottom:8px">
      <textarea id="post-content" placeholder="内容" style="width:100%;min-height:120px;padding:10px;border:1px solid #e6e6e6;border-radius:6px"></textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button id="clear-post" class="btn">清空</button>
        <button id="submit-post" class="btn btn-primary">发布帖子</button>
      </div>
    </div>

    <div id="boards" class="board-grid"></div>
  </div>

  <!-- post modal -->
  <div class="modal" id="post-modal">
    <div class="modal-content">
      <h3 id="modal-title"></h3>
      <div id="modal-meta" style="color:#666;margin-bottom:8px"></div>
      <div id="modal-body" style="white-space:pre-wrap"></div>

      <div style="margin-top:12px">
        <div style="font-weight:700">评论</div>
        <div id="modal-comments" class="comment-list"></div>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:flex-start">
          <div class="avatar" id="comment-avatar"><img src="" alt="avatar"></div>
          <textarea id="comment-input" style="flex:1;padding:8px;border:1px solid #e6e6e6;border-radius:6px"></textarea>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button id="cancel-comment" class="btn">取消</button>
          <button id="submit-comment" class="btn btn-primary">发布评论</button>
        </div>
      </div>

      <div style="text-align:right;margin-top:12px"><button id="close-post-modal" class="btn">关闭</button></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  /* ========== 配置：请替换为你自己的 firebaseConfig ========== */
  const firebaseConfig = {
    apiKey: "AIzaSyAzIUyu2Oj0nGgkc6h3qnS6DQkkxsBxzu8",
    authDomain: "guairenxiehui-e3d59.firebaseapp.com",
    databaseURL: "https://guairenxiehui-e3d59-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "guairenxiehui-e3d59",
    storageBucket: "guairenxiehui-e3d59.firebasestorage.app",
    messagingSenderId: "570598758945",
    appId: "1:570598758945:web:5321c2f2d7dd4a7d9fa160",
    measurementId: "G-9VNTHKZBP0"
  };
  /* ============================================================ */

  if(!window.firebase) throw new Error('Firebase SDK 未加载');
  if(!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // 论坛版块定义（可扩展）
  const BOARDS = { tactics:'作战经验', recruit:'招新公告', intel:'情报快报' };

  // 默认头像（data URI，避免外部请求）
  const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="100%" height="100%" fill="#ffffff"/><circle cx="100" cy="70" r="40" fill="#000"/><rect x="40" y="120" width="120" height="50" rx="8" fill="#000"/></svg>'
  );

  // 避免全局 $ 冲突，使用 qs / qsa
  function qs(s){ return document.querySelector(s); }
  function qsa(s){ return Array.from(document.querySelectorAll(s)); }

  let currentUser = null; // {uid, email}
  window.users = window.users || {}; // 缓存 users/{uid}

  document.addEventListener('DOMContentLoaded', ()=>{
    setupUI();
    initAuth();
    listenBoards();
  });

  function setupUI(){
    // render board containers
    const boardsEl = qs('#boards');
    boardsEl.innerHTML = '';
    for(const k in BOARDS){
      const card = document.createElement('div');
      card.className = 'board-card';
      card.innerHTML = `<div style="font-weight:700;margin-bottom:8px">${BOARDS[k]}</div><div id="posts-${k}"><div style="color:#999">加载中...</div></div>`;
      boardsEl.appendChild(card);
    }

    qs('#clear-post').addEventListener('click', ()=>{ qs('#post-title').value=''; qs('#post-content').value=''; });
    qs('#submit-post').addEventListener('click', submitPost);
    qs('#close-post-modal').addEventListener('click', ()=> qs('#post-modal').style.display='none');
    qs('#cancel-comment').addEventListener('click', ()=> qs('#comment-input').value='');
    qs('#submit-comment').addEventListener('click', submitComment);
  }

  // Auth 状态监听
  function initAuth(){
    auth.onAuthStateChanged(async user=>{
      if(user){
        currentUser = { uid:user.uid, email:user.email };
        // 加载该用户资料（nickname/avatar/role）到 window.users
        const snap = await db.ref('users/'+user.uid).get();
        if(snap.exists()) window.users[user.uid] = snap.val();
        qs('#user-status').textContent = '当前：' + (window.users[user.uid]?.nickname || user.email);
        qs('#comment-avatar img').src = window.users[user.uid]?.avatar || DEFAULT_AVATAR;
      } else {
        currentUser = null;
        qs('#user-status').textContent = '未登录（请回成员页登录）';
        qs('#comment-avatar img').src = DEFAULT_AVATAR;
      }
    });
  }

  // 监听各版块帖子
  function listenBoards(){
    for(const k in BOARDS){
      db.ref('forum/'+k).on('value', snap=>{
        const val = snap.val() || {};
        renderBoard(k, val);
      });
    }
  }

  function renderBoard(boardKey, data){
    const postsEl = qs('#posts-'+boardKey);
    postsEl.innerHTML = '';
    const items = Object.entries(data).map(([id,v])=>({id,...v}));
    items.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
    if(items.length===0){ postsEl.innerHTML = '<div style="color:#999">暂无帖子</div>'; return; }
    items.forEach(item=>{
      const row = document.createElement('div');
      row.className = 'post-item';
      const userObj = window.users[item.author] || { nickname: item.author, avatar: DEFAULT_AVATAR };
      row.innerHTML = `<div class="avatar"><img src="${userObj.avatar||DEFAULT_AVATAR}" alt="a"></div>
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">${escapeHtml(item.title)}</div>
            <div class="post-meta">${new Date(item.timestamp).toLocaleString()} · ${escapeHtml(userObj.nickname||item.author)}</div>
          </div>
          <div style="margin-top:8px;color:#444">${truncate(escapeHtml(item.content),180)}</div>
          <div class="post-actions" style="margin-top:8px"></div>
        </div>`;
      postsEl.appendChild(row);

      // actions
      const actions = row.querySelector('.post-actions');
      const isAuthor = currentUser && currentUser.uid === item.author;
      const isAdmin = currentUser && window.users[currentUser.uid] && window.users[currentUser.uid].role === 'admin';

      if(isAuthor){
        const edit = createBtn('编辑', ()=> editPost(boardKey, item));
        actions.appendChild(edit);
      }
      if(isAuthor || isAdmin){
        const del = createBtn('删除', ()=> {
          if(confirm('确认删除？')) db.ref('forum/'+boardKey+'/'+item.id).remove();
        });
        actions.appendChild(del);
      }

      row.addEventListener('click',(e)=>{
        if(e.target.closest('.post-actions')) return;
        openPostModal(boardKey, item);
      });
    });
  }

  function createBtn(text, onClick){
    const b = document.createElement('button'); b.className='btn'; b.style.marginLeft='6px'; b.textContent=text; b.addEventListener('click', (e)=>{ e.stopPropagation(); onClick(); });
    return b;
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function truncate(s,n){ return s.length>n? s.slice(0,n)+'...': s; }

  // 发布帖子
  async function submitPost(){
    if(!currentUser){ alert('请先登录（成员页）'); return; }
    const title = qs('#post-title').value.trim(); const content = qs('#post-content').value.trim();
    if(!title||!content){ alert('标题与内容不能为空'); return; }
    // 默认发到作战经验（可扩展）
    const boardKey = 'tactics';
    const post = { author: currentUser.uid, title, content, timestamp: Date.now() };
    const ref = db.ref('forum/'+boardKey).push();
    await ref.set(post);
    qs('#post-title').value=''; qs('#post-content').value='';
    alert('发布成功');
  }

  // 打开帖子模态框并加载评论
  function openPostModal(boardKey,item){
    qs('#post-modal').style.display='flex';
    qs('#modal-title').textContent = item.title;
    qs('#modal-meta').textContent = BOARDS[boardKey] + ' · ' + new Date(item.timestamp).toLocaleString();
    qs('#modal-body').textContent = item.content;
    qs('#post-modal').dataset.board = boardKey;
    qs('#post-modal').dataset.postid = item.id;
    loadComments(boardKey,item.id);
  }

  // 评论加载
  function loadComments(board,postid){
    const container = qs('#modal-comments');
    container.innerHTML = '加载中...';
    const ref = db.ref('forum/'+board+'/'+postid+'/comments');
    ref.off(); // 防止重复绑定
    ref.on('value', snap=>{
      const data = snap.val() || {};
      container.innerHTML = '';
      const arr = Object.entries(data).map(([id,v])=>({id,...v})).sort((a,b)=>a.timestamp - b.timestamp);
      if(arr.length===0) container.innerHTML='<div style="color:#999">暂无评论</div>';
      arr.forEach(c=>{
        const u = window.users[c.author] || { nickname: c.author, avatar: DEFAULT_AVATAR };
        const div = document.createElement('div'); div.style.padding='8px 0'; div.style.borderBottom='1px solid #f5f5f5';
        div.innerHTML = `<div style="display:flex;gap:8px"><div class="avatar"><img src="${u.avatar||DEFAULT_AVATAR}"></div><div style="flex:1"><div style="font-weight:600">${escapeHtml(u.nickname||c.author)} <span style="color:#777;font-weight:400;font-size:12px"> · ${new Date(c.timestamp).toLocaleString()}</span></div><div style="margin-top:6px">${escapeHtml(c.content)}</div></div></div>`;
        // actions
        const isAuthor = currentUser && currentUser.uid===c.author;
        const isAdmin = currentUser && window.users[currentUser.uid] && window.users[currentUser.uid].role==='admin';
        if(isAuthor||isAdmin){
          const bar = document.createElement('div'); bar.style.marginTop='6px'; bar.style.display='flex'; bar.style.gap='6px';
          const del = createBtn('删除', ()=> { if(confirm('删除该评论？')) db.ref('forum/'+board+'/'+postid+'/comments/'+c.id).remove(); });
          bar.appendChild(del);
          if(isAuthor){
            const edit = createBtn('编辑', ()=> {
              const s = prompt('编辑评论', c.content); if(s==null) return; db.ref('forum/'+board+'/'+postid+'/comments/'+c.id).update({ content: s });
            });
            bar.appendChild(edit);
          }
          div.appendChild(bar);
        }
        container.appendChild(div);
      });
    });
  }

  // 发布评论
  async function submitComment(){
    if(!currentUser){ alert('请先登录'); return; }
    const board = qs('#post-modal').dataset.board;
    const postid = qs('#post-modal').dataset.postid;
    const content = qs('#comment-input').value.trim();
    if(!content){ alert('请输入评论'); return; }
    const ref = db.ref('forum/'+board+'/'+postid+'/comments').push();
    await ref.set({ author: currentUser.uid, content, timestamp: Date.now() });
    qs('#comment-input').value='';
  }

  // 编辑帖子（简单 prompt）
  function editPost(board,item){
    const t = prompt('编辑标题', item.title); if(t==null) return;
    const c = prompt('编辑内容', item.content); if(c==null) return;
    db.ref('forum/'+board+'/'+item.id).update({ title:t, content:c });
  }

  </script>
</body>
</html>
