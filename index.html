<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>怪人协会 - 成员管理系统</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://via.placeholder.com/32" type="image/x-icon">

    <!-- 阻止恶意与扩展注入脚本 -->
    <meta http-equiv="Content-Security-Policy"
          content="script-src 'self' https://www.gstatic.com https://www.googletagmanager.com 'unsafe-inline';
                   object-src 'none';">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            width: 1200px;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }
        header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #000;
            text-decoration: none;
        }
        .nav-menu {
            display: flex;
            gap: 24px;
        }
        .nav-link {
            color: #333;
            text-decoration: none;
            font-size: 16px;
            transition: color 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: #000;
            font-weight: 500;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .btn {
            padding: 8px 16px;
            border: 1px solid #000;
            background: #fff;
            color: #000;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn:hover {
            background: #000;
            color: #fff;
        }
        .btn-primary {
            background: #000;
            color: #fff;
        }
        .btn-primary:hover {
            background: #333;
        }
        main {
            padding: 40px 0;
        }
        .page-section {
            background: #fff;
            border-radius: 8px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .page-title {
            font-size: 28px;
            margin-bottom: 24px;
            font-weight: 700;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 16px;
        }
        .title-line {
            height: 4px;
            width: 80px;
            background: #000;
            margin-bottom: 32px;
        }
        /* 登录注册弹窗 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: #fff;
            padding: 32px;
            width: 400px;
            max-width: 90%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .modal-title {
            font-size: 24px;
            margin-bottom: 24px;
            text-align: center;
            font-weight: 700;
        }
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-input:focus {
            outline: none;
            border-color: #000;
        }
        .modal-btns {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

    </style>
</head>
<body>
<header>
    <div class="container nav">
        <a href="./index.html" class="logo">怪人协会</a>
        <div class="nav-menu">
            <a href="./index.html" class="nav-link active">成员查询</a>
            <a href="./forum.html" class="nav-link">论坛交流</a>
            <a href="#" class="nav-link">绘画大赛</a>
            <a href="#" class="nav-link">SXP收容所</a>
        </div>
        <div class="user-info">
            <span class="username-display">未登录</span>
            <button id="login-btn" class="btn">登录</button>
            <button id="register-btn" class="btn btn-primary">注册</button>
            <button id="logout-btn" class="btn" style="display:none;">退出登录</button>
        </div>
    </div>
</header>

<main class="container">
<section id="member-page" class="page-section">
    <h2 class="page-title">怪人协会 - 部门成员总览</h2>
    <div class="title-line"></div>

    <!--部门筛选-->
    <div class="dept-filter" style="margin-bottom:24px;display:flex;flex-wrap:wrap;gap:12px;">
        <button class="dept-filter-btn active" data-dept="all">全部部门</button>
        <button class="dept-filter-btn" data-dept="defense">会防部</button>
        <button class="dept-filter-btn" data-dept="clearing">清算部</button>
        <button class="dept-filter-btn" data-dept="coordination">统筹部</button>
        <button class="dept-filter-btn" data-dept="economic">经济部</button>
        <button class="dept-filter-btn" data-dept="info-sec">信息安全部</button>
    </div>

    <!--成员卡容器-->
    <div class="member-cards-container"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:24px;">
    </div>

    <!--处分弹窗-->
    <div class="punishment-modal modal">
        <div class="modal-content">
            <h3 class="modal-title">添加处分记录</h3>
            <input type="hidden" id="target-member-id">
            <div class="form-group">
                <label class="form-label">处分类型</label>
                <select id="punishment-type" class="form-input">
                    <option value="current">当前处分</option>
                    <option value="history">既往处分</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">处分内容</label>
                <textarea id="punishment-content" class="form-input"
                          style="resize:vertical;height:100px"
                          placeholder="请输入处分内容..."></textarea>
            </div>
            <div class="modal-btns">
                <button id="cancel-punishment" class="btn">取消</button>
                <button id="confirm-punishment" class="btn btn-primary">确认添加</button>
            </div>
        </div>
    </div>
</section>
</main>

<!-- 登录弹窗 -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">用户登录</h3>
        <div class="form-group">
            <label class="form-label">用户名</label>
            <input type="text" id="login-username" class="form-input"
                   placeholder="请输入用户名">
        </div>
        <div class="form-group">
            <label class="form-label">密码</label>
            <input type="password" id="login-password" class="form-input"
                   placeholder="请输入密码">
        </div>
        <div class="modal-btns">
            <button id="cancel-login" class="btn">取消</button>
            <button id="submit-login" class="btn btn-primary">登录</button>
        </div>
    </div>
</div>

<!-- 注册弹窗 -->
<div id="register-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">用户注册</h3>
        <div class="form-group">
            <label class="form-label">用户名</label>
            <input type="text" id="register-username" class="form-input"
                   placeholder="请输入用户名">
        </div>
        <div class="form-group">
            <label class="form-label">密码</label>
            <input type="password" id="register-password" class="form-input"
                   placeholder="请输入密码（至少6位）">
        </div>
        <div class="modal-btns">
            <button id="cancel-register" class="btn">取消</button>
            <button id="submit-register" class="btn btn-primary">注册</button>
        </div>
    </div>
</div>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// =========================
// Firebase 配置
// =========================
const firebaseConfig = {
  apiKey: "AIzaSyAzIUyu2Oj0nGgkc6h3qnS6DQkkxsBxzu8",
  authDomain: "guairenxiehui-e3d59.firebaseapp.com",
  databaseURL: "https://guairenxiehui-e3d59-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "guairenxiehui-e3d59",
  storageBucket: "guairenxiehui-e3d59.firebasestorage.app",
  messagingSenderId: "570598758945",
  appId: "1:570598758945:web:5321c2f2d7dd4a7d9fa160",
  measurementId: "G-9VNTHKZBP0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
const ADMIN_USERNAME = "admin";
let members = [];

// =========================
// 页面加载后初始化
// =========================
document.addEventListener("DOMContentLoaded", () => {
    initUserStatus();
    initLoginRegisterModal();
    initLogout();
    ensureDefaultMembers();
    initPunishmentModal();
    initMemberFilter();
});

// =========================
// 用户状态显示
// =========================
function initUserStatus() {
    const saved = localStorage.getItem("guairen_user");
    if(saved){
        currentUser = JSON.parse(saved);
        updateUserDisplay();
    }
}

function updateUserDisplay(){
    const name = document.querySelector(".username-display");
    const loginBtn = document.getElementById("login-btn");
    const regBtn = document.getElementById("register-btn");
    const logoutBtn = document.getElementById("logout-btn");

    if(currentUser){
        name.innerText = `欢迎，${currentUser.username}`;
        loginBtn.style.display = "none";
        regBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
    } else {
        name.innerText = "未登录";
        loginBtn.style.display = "inline-block";
        regBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
    }
}

// =========================
// 登录注册弹窗逻辑
// =========================
function initLoginRegisterModal(){
    const loginModal = document.getElementById("login-modal");
    const loginBtn = document.getElementById("login-btn");
    loginBtn.addEventListener("click",()=>loginModal.style.display="flex");
    document.getElementById("cancel-login").addEventListener("click",()=>loginModal.style.display="none");
    loginModal.addEventListener("click",e=>e.target===loginModal&&(loginModal.style.display="none"));

    document.getElementById("submit-login").addEventListener("click",()=>{
        const user = document.getElementById("login-username").value.trim();
        const pwd = document.getElementById("login-password").value.trim();
        if(!user||!pwd) return alert("请输入完整信息");
        db.ref("users/"+user).once("value").then(snap=>{
            const u=snap.val();
            if(!u||u.password!==pwd) return alert("用户名或密码错误");
            currentUser=u;
            localStorage.setItem("guairen_user",JSON.stringify(u));
            loginModal.style.display="none";
            updateUserDisplay();
            renderMemberCards(document.querySelector(".dept-filter-btn.active").dataset.dept);
        });
    });

    const regModal = document.getElementById("register-modal");
    document.getElementById("register-btn").addEventListener("click",()=>regModal.style.display="flex");
    document.getElementById("cancel-register").addEventListener("click",()=>regModal.style.display="none");
    regModal.addEventListener("click",e=>e.target===regModal&&(regModal.style.display="none"));

    document.getElementById("submit-register").addEventListener("click",()=>{
        const user=document.getElementById("register-username").value.trim();
        const pwd=document.getElementById("register-password").value.trim();
        if(!user||!pwd) return alert("请填写完整");
        if(pwd.length<6) return alert("密码至少6位");
        const role = user===ADMIN_USERNAME?"admin":"user";
        const obj={username:user,password:pwd,role};
        db.ref("users/"+user).set(obj);
        alert("注册成功，请登录");
        regModal.style.display="none";
    });
}

// =========================
// 退出登录
// =========================
function initLogout(){
    document.getElementById("logout-btn").addEventListener("click",()=>{
        currentUser=null;
        localStorage.removeItem("guairen_user");
        updateUserDisplay();
        renderMemberCards("all");
    });
}

// =========================
// 成员数据初始化
// =========================
async function ensureDefaultMembers(){
    const ref=db.ref("members");
    const snap=await ref.once("value");
    if(!snap.exists()){
        const def={};
        [
            ["1","王沛霖","defense","会防部","部长","男"],
            ["2","王楚恩","defense","会防部","成员","女"],
            ["3","靳海逸","defense","会防部","成员","男","清算部"],
            ["4","李瑾睿","clearing","清算部","部长","男"],
            ["5","赵雅晗","clearing","清算部","成员","女"],
            ["6","闫家栋","coordination","统筹部","部长","男"],
            ["7","肖亚旭","coordination","统筹部","成员","男"],
            ["8","宿容","coordination","统筹部","成员","女"],
            ["9","陈雨琪","coordination","统筹部","成员","女"],
            ["10","刘萱楠","coordination","统筹部","成员","女"],
            ["11","张起华","economic","经济部","部长","男"],
            ["12","张泽楷","economic","经济部","成员","男"],
            ["13","刘汪浩","info-sec","信息安全部","部长","男"],
            ["14","吴昊鹏","info-sec","信息安全部","成员","男"],
            ["15","夏浚宸","info-sec","信息安全部","成员","男"],
            ["16","丁嘉禾","info-sec","信息安全部","成员","男"]
        ].forEach(d=>{
            def[d[0]]={
                id:d[0],name:d[1],dept:d[2],deptName:d[3],
                role:d[4],gender:d[5],
                currentPunishment:"无",
                historyPunishment:["无"],
                crossDept:d[6]||null
            };
        });
        await ref.set(def);
    }
    ref.on("value",snap=>{
        members=Object.values(snap.val());
        renderMemberCards(document.querySelector(".dept-filter-btn.active").dataset.dept);
    });
}

// =========================
// 部门筛选
// =========================
function initMemberFilter(){
    document.querySelectorAll(".dept-filter-btn").forEach(btn=>{
        btn.addEventListener("click",()=>{
            document.querySelectorAll(".dept-filter-btn").forEach(x=>x.classList.remove("active"));
            btn.classList.add("active");
            renderMemberCards(btn.dataset.dept);
        });
    });
}

// =========================
// 渲染成员卡片
// =========================
function renderMemberCards(dept){
    const box=document.querySelector(".member-cards-container");
    box.innerHTML="";
    const arr=dept==="all"?members:members.filter(x=>x.dept===dept);
    arr.forEach(m=>{
        box.insertAdjacentHTML("beforeend",`
          <div style="border:1px solid #E0E0E0;padding:20px;border-radius:4px;">
            <h3>${m.name}</h3>
            <div>${m.deptName} - ${m.role}</div>
            <div>性别：${m.gender}</div>
          </div>
        `);
    });
}
</script>

</body>
</html>
